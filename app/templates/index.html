{% extends "base.html" %}
{% block title %}ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸{% endblock %}
{% block content %}
<h1>è£œåŠ©é‡‘è¦é ˜PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>

<form action="/upload" method="post" enctype="multipart/form-data">
  <input type="file" name="file" accept="application/pdf,image/*" required>
  <button type="submit">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
</form>

{% if filename %}
  <h2>ãƒ•ã‚¡ã‚¤ãƒ«å: {{ filename }}</h2>
  <h3>GPTã«ã‚ˆã‚‹è§£æçµæœ:</h3>
  <pre>{{ result }}</pre>
  <button id="openChatBtn">ğŸ’¬ è³ªå•ã¯ã“ã¡ã‚‰</button>
{% endif %}

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆLINEé¢¨ãƒãƒ£ãƒƒãƒˆï¼‰ -->
<div id="chatModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); z-index:1000;">
  <div style="background:#fff; padding:20px; margin:5% auto; width:90%; max-width:600px; border-radius:8px;">
    <span id="closeChatModal" style="float:right; cursor:pointer;">âŒ</span>
    <h3>AIãƒãƒ£ãƒƒãƒˆ</h3>

    <div id="chatWindow" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; margin-bottom:10px;">
      <!-- å¹ãå‡ºã—ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
    </div>

    <form id="chatForm">
      <textarea id="userQuestion" rows="3" style="width:100%;" placeholder="AIã«è³ªå•ã—ã¦ã¿ã‚ˆã†" required></textarea><br>
      <button type="submit">é€ä¿¡</button>
    </form>
  </div>
</div>

<script>
  const openBtn = document.getElementById("openChatBtn");
  const modal = document.getElementById("chatModal");
  const closeBtn = document.getElementById("closeChatModal");
  const chatWindow = document.getElementById("chatWindow");

  if (openBtn) openBtn.onclick = () => modal.style.display = "block";
  if (closeBtn) closeBtn.onclick = () => modal.style.display = "none";

  const chatForm = document.getElementById("chatForm");
  if (chatForm) {
    chatForm.onsubmit = async (e) => {
      e.preventDefault();
      const question = document.getElementById("userQuestion").value;

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼å¹ãå‡ºã—
      const userBubble = document.createElement("div");
      userBubble.innerHTML = `<div style="text-align:right;"><div style="display:inline-block; background:#DCF8C6; padding:10px; border-radius:10px; margin:5px;">${question}</div></div>`;
      chatWindow.appendChild(userBubble);
      chatWindow.scrollTop = chatWindow.scrollHeight;

      try {
        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question })
        });

        const data = await response.json();
        const aiAnswer = data.answer || "ï¼ˆAIã®å›ç­”ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰";

        // AIå¹ãå‡ºã—
        const aiBubble = document.createElement("div");
        aiBubble.innerHTML = `<div style="text-align:left;"><div style="display:inline-block; background:#F1F0F0; padding:10px; border-radius:10px; margin:5px;">${aiAnswer}</div></div>`;
        chatWindow.appendChild(aiBubble);
        chatWindow.scrollTop = chatWindow.scrollHeight;

      } catch (error) {
        const errorBubble = document.createElement("div");
        errorBubble.innerHTML = `<div style="text-align:left;"><div style="display:inline-block; background:#F8D7DA; padding:10px; border-radius:10px; margin:5px; color:#721c24;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div></div>`;
        chatWindow.appendChild(errorBubble);
      }

      document.getElementById("userQuestion").value = "";
    };
  }
</script>
{% endblock %}
